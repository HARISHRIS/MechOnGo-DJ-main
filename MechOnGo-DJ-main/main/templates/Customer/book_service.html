{% extends 'general/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}MechOnGO | Book Service{% endblock %}
{% block footer %}{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    .gradient-bg {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .modal-animation {
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .form-input, input[type='text'], input[type='email'], input[type='number'], input[type='password'], input[type='tel'], input[type='date'], input[type='time'], textarea, select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        background-color: #FFFFFF;
        color: #111827;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
        box-sizing: border-box;
    }
    textarea {
        min-height: 120px;
        resize: vertical;
    }
    input:focus, textarea:focus, select:focus {
        border-color: #2563EB;
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    input::placeholder, textarea::placeholder {
        color: #6B7280;
        opacity: 1;
    }
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 1rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }
    #id_payment_method {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
    }
    #id_payment_method label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }
    #id_payment_method input[type="radio"] {
        width: 1.25em;
        height: 1.25em;
        border: 1px solid #6B7280;
        accent-color: #2563EB;
        box-shadow: none;
    }
    #online-payment-fields input {
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen gradient-bg py-12 px-4 sm:px-6 lg:px-8 animate__animated animate__fadeIn">
    {% if user.is_authenticated and not user.profile.is_mechanic %}
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-teal-800 tracking-tight">Schedule Your Vehicle Service</h1>
                <p class="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">Complete the form below to book an appointment with our certified mechanics. We'll contact you to confirm your booking.</p>
            </div>

            <!-- Form Errors -->
            {% if form.errors %}
                <div class="bg-white rounded-2xl shadow-lg card-hover mb-8 p-6 border-l-4 border-red-600 animate__animated animate__fadeIn">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-teal-800">There were errors with your submission</h3>
                            <div class="mt-2 text-sm text-gray-600">
                                <ul class="list-disc pl-5 space-y-1">
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li>{{ field.label }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Booking Form -->
            <div class="bg-white rounded-2xl shadow-lg card-hover overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <h2 class="text-2xl font-semibold text-white">Service Request Form</h2>
                    </div>
                </div>

                <form method="post" id="booking-form" class="p-8 space-y-10">
                    {% csrf_token %}
                    <!-- Issue Description -->
                    <div class="space-y-4">
                        <div>
                            <label for="{{ form.issue_description.id_for_label }}" class="block text-base font-medium text-teal-800">Describe Your Vehicle's Issue <span class="text-red-600">*</span></label>
                            <p class="mt-1 text-sm text-gray-600">Please be as detailed as possible to help us serve you better.</p>
                        </div>
                        {% render_field form.issue_description placeholder="e.g., Engine is making a rattling noise, brakes feel soft..." %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Preferred Date -->
                        <div class="space-y-4">
                            <label for="{{ form.preferred_date.id_for_label }}" class="block text-base font-medium text-teal-800">Preferred Date <span class="text-red-600">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                    <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                {% render_field form.preferred_date class+="pl-10" %}
                            </div>
                        </div>

                        <!-- Preferred Time -->
                        <div class="space-y-4">
                            <label for="{{ form.preferred_time.id_for_label }}" class="block text-base font-medium text-teal-800">Preferred Time <span class="text-red-600">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                    <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                {% render_field form.preferred_time class+="pl-10" %}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="border-t border-gray-200 pt-10">
                        <div class="flex items-center mb-8">
                            <svg class="h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-teal-800">Contact Information</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Phone Number -->
                            <div class="space-y-4">
                                <label for="{{ form.phone_number.id_for_label }}" class="block text-base font-medium text-teal-800">Phone Number <span class="text-red-600">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                        <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 20" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                        </svg>
                                    </div>
                                    {% render_field form.phone_number placeholder="555-555-5555" class+="pl-10" %}
                                </div>
                            </div>

                            <!-- Location -->
                            <div class="space-y-4">
                                <label for="{{ form.location.id_for_label }}" class="block text-base font-medium text-teal-800">Service Location <span class="text-red-600">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                                        <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                    {% render_field form.location placeholder="e.g., 123 Main St, Anytown" class+="pl-10" %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Information -->
                    <div class="border-t border-gray-200 pt-10">
                        <div class="flex items-center mb-8">
                            <svg class="h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-teal-800">Vehicle Information</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="space-y-4">
                                <label for="{{ form.vehicle_make.id_for_label }}" class="block text-base font-medium text-teal-800">Make <span class="text-red-600">*</span></label>
                                {% render_field form.vehicle_make placeholder="e.g., Toyota" %}
                            </div>
                            <div class="space-y-4">
                                <label for="{{ form.vehicle_model.id_for_label }}" class="block text-base font-medium text-teal-800">Model <span class="text-red-600">*</span></label>
                                {% render_field form.vehicle_model placeholder="e.g., Camry" %}
                            </div>
                            <div class="space-y-4">
                                <label for="{{ form.vehicle_year.id_for_label }}" class="block text-base font-medium text-teal-800">Year <span class="text-red-600">*</span></label>
                                {% render_field form.vehicle_year placeholder="e.g., 2021" %}
                            </div>
                            <div class="md:col-span-3 space-y-4">
                                <label for="{{ form.vehicle_license.id_for_label }}" class="block text-base font-medium text-teal-800">License Plate <span class="text-red-600">*</span></label>
                                {% render_field form.vehicle_license placeholder="e.g., ABC-123" %}
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="border-t border-gray-200 pt-10">
                        <div class="flex items-center mb-8">
                            <svg class="h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            <h3 class="text-xl font-semibold text-teal-800">Payment Method</h3>
                        </div>
                        <div class="space-y-4">
                            {{ form.payment_method }}
                            <div id="online-payment-fields" class="hidden mt-6 space-y-4 p-6 bg-gray-50 rounded-lg">
                                <div>
                                    <label for="card-number" class="block text-sm font-medium text-teal-800">Card Number</label>
                                    <input type="text" id="card-number" name="card_number" placeholder="1234 5678 9012 3456" autocomplete="cc-number" class="mt-1 block w-full">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="expiry-date" class="block text-sm font-medium text-teal-800">Expiry Date</label>
                                        <input type="text" id="expiry-date" name="expiry_date" placeholder="MM/YY" autocomplete="cc-exp" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="cvv" class="block text-sm font-medium text-teal-800">CVV</label>
                                        <input type="text" id="cvv" name="cvv" placeholder="123" autocomplete="cc-csc" class="mt-1 block w-full">
                                    </div>
                                </div>
                                <div>
                                    <label for="card-name" class="block text-sm font-medium text-teal-800">Name on Card</label>
                                    <input type="text" id="card-name" name="card_name" placeholder="John Smith" autocomplete="cc-name" class="mt-1 block w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="space-y-4">
                        <div>
                            <label for="{{ form.additional_notes.id_for_label }}" class="block text-base font-medium text-teal-800">Additional Notes</label>
                            <p class="mt-1 text-sm text-gray-600">Any special requests or information about your vehicle.</p>
                        </div>
                        {% render_field form.additional_notes placeholder="e.g., Please check the tire pressure as well." %}
                    </div>

                    <div class="mt-12 flex justify-end">
                        <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition card-hover">
                            <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Confirm Booking
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="max-w-md mx-auto text-center py-16 bg-white rounded-2xl shadow-lg card-hover">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-4 text-lg font-semibold text-teal-800">Access Restricted</h3>
            <p class="mt-2 text-sm text-gray-600">You need to be logged in as a customer to view this page.</p>
            <div class="mt-6 flex justify-center space-x-4">
                <a href="{% url 'login' %}?next={% url 'book_service' %}" class="inline-flex items-center px-6 py-3 text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition card-hover">
                    Sign In
                </a>
                <a href="{% url 'signup' %}" class="inline-flex items-center px-6 py-3 text-base font-medium rounded-lg text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 transition card-hover">
                    Register
                </a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        flatpickr("#id_preferred_date", {
            minDate: "today",
            dateFormat: "Y-m-d",
        });

        flatpickr("#id_preferred_time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "h:i K",
            time_24hr: false,
            minuteIncrement: 15,
        });

        const onlinePaymentRadio = document.getElementById('id_payment_method_1');
        const cashPaymentRadio = document.getElementById('id_payment_method_0');
        const onlinePaymentFields = document.getElementById('online-payment-fields');

        function togglePaymentFields() {
            if (onlinePaymentFields && onlinePaymentRadio && onlinePaymentRadio.checked) {
                onlinePaymentFields.classList.remove('hidden');
            } else if (onlinePaymentFields) {
                onlinePaymentFields.classList.add('hidden');
            }
        }

        if (onlinePaymentRadio && cashPaymentRadio) {
            onlinePaymentRadio.addEventListener('change', togglePaymentFields);
            cashPaymentRadio.addEventListener('change', togglePaymentFields);
            togglePaymentFields();
        }

        const cardNumberInput = document.getElementById('card-number');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^\d\s]/g, '').replace(/(\d{4})/g, '$1 ').trim();
            });
        }

        const expiryDateInput = document.getElementById('expiry-date');
        if (expiryDateInput) {
            expiryDateInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^\d]/g, '');
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        const cvvInput = document.getElementById('cvv');
        if (cvvInput) {
            cvvInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^\d]/g, '').substring(0, 4);
            });
        }

        const phoneInput = document.getElementById('id_phone_number');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) value = value.substring(0, 10);
                let formattedValue = '';
                if (value.length > 6) {
                    formattedValue = `${value.substring(0, 3)}-${value.substring(3, 6)}-${value.substring(6)}`;
                } else if (value.length > 3) {
                    formattedValue = `${value.substring(0, 3)}-${value.substring(3)}`;
                } else {
                    formattedValue = value;
                }
                e.target.value = formattedValue;
            });
        }
    } catch (e) {
        console.error('Booking form initialization error:', e);
    }
});
</script>
{% endblock %}